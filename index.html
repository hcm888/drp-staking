<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="DRPè´¨æŠ¼èµå›DApp - ä¸“ä¸ºTPé’±åŒ…ä¼˜åŒ–">
    <meta name="keywords" content="è´¨æŠ¼,èµå›,DApp,TPé’±åŒ…,åŒºå—é“¾,DeFi">
    <title>DRPè´¨æŠ¼èµå›ç®¡ç†</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’°</text></svg>">
    <style>
        :root {
            --primary-color: #4cd964;
            --primary-dark: #2ecc71;
            --secondary-color: #3498db;
            --background-dark: #0a0a1f;
            --background-card: rgba(26, 26, 62, 0.9);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --border-color: rgba(255, 255, 255, 0.1);
            --success-color: #4cd964;
            --warning-color: #ff9500;
            --error-color: #ff3b30;
            --shadow-default: 0 10px 30px rgba(0, 0, 0, 0.5);
            --border-radius: 16px;
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 20px;
            --spacing-xl: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0a0a1f 0%, #1a1a3e 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: var(--spacing-md);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg) 0;
            margin-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logo-icon {
            font-size: 24px;
            color: var(--primary-color);
        }

        .logo-text {
            font-size: 20px;
            font-weight: 600;
        }

        .network-info {
            background: var(--primary-color);
            color: #000;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background: var(--background-card);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .stat-unit {
            font-size: 14px;
            color: var(--text-secondary);
            margin-left: var(--spacing-xs);
        }

        .action-card {
            background: var(--background-card);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .input-group {
            margin-bottom: var(--spacing-lg);
        }

        .input-label {
            display: block;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .input-wrapper {
            position: relative;
            margin-bottom: var(--spacing-sm);
        }

        .amount-input {
            width: 100%;
            padding: var(--spacing-lg);
            background: rgba(10, 10, 31, 0.5);
            border: 2px solid rgba(76, 217, 100, 0.3);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            outline: none;
            transition: all 0.3s ease;
        }

        .amount-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 217, 100, 0.1);
        }

        .token-symbol {
            position: absolute;
            right: var(--spacing-lg);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-weight: 500;
        }

        .percentage-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .percentage-btn {
            padding: var(--spacing-md);
            background: rgba(58, 58, 110, 0.5);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .percentage-btn:hover {
            background: rgba(76, 217, 100, 0.2);
            border-color: var(--primary-color);
        }

        .percentage-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: #000;
            font-weight: 600;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .action-btn {
            padding: var(--spacing-lg);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: #000;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(58, 58, 110, 0.8);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .records-card {
            background: var(--background-card);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .refresh-btn {
            background: rgba(58, 58, 110, 0.8);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .records-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .record-item {
            background: rgba(10, 10, 31, 0.5);
            border-radius: 12px;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            border-left: 4px solid var(--primary-color);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .record-amount {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .record-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .record-status {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: rgba(76, 217, 100, 0.2);
            color: var(--primary-color);
        }

        .status-completed {
            background: rgba(52, 152, 219, 0.2);
            color: var(--secondary-color);
        }

        .connect-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: var(--spacing-lg);
            background: linear-gradient(to top, rgba(10, 10, 31, 0.95), transparent);
            backdrop-filter: blur(20px);
        }

        .connect-btn {
            width: 100%;
            padding: var(--spacing-lg);
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border: none;
            border-radius: var(--border-radius);
            color: #000;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-default);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        .connect-btn:active {
            transform: scale(0.98);
        }

        .connect-btn.connected {
            background: #27ae60;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: var(--spacing-md);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--background-card);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: var(--spacing-xs);
        }

        .modal-body {
            margin-bottom: var(--spacing-lg);
        }

        .transaction-info {
            background: rgba(10, 10, 31, 0.5);
            border-radius: 12px;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
        }

        .info-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .info-label {
            color: var(--text-secondary);
        }

        .info-value {
            font-weight: 600;
        }

        .modal-footer {
            display: flex;
            gap: var(--spacing-md);
        }

        .modal-btn {
            flex: 1;
            padding: var(--spacing-md);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-btn:active {
            transform: scale(0.98);
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: #000;
        }

        .modal-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .loading {
            text-align: center;
            padding: var(--spacing-xl);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-md);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-secondary);
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: var(--text-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--border-radius);
            z-index: 10000;
            font-size: 14px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            max-width: 90%;
            text-align: center;
            animation: toastSlideIn 0.3s ease;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .error-message {
            color: var(--error-color);
            font-size: 12px;
            margin-top: var(--spacing-xs);
            display: none;
        }

        .error-message.show {
            display: block;
        }

        @media (max-width: 480px) {
            .container {
                padding: var(--spacing-sm);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .percentage-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">ğŸ’°</div>
                <div class="logo-text">DRPè´¨æŠ¼èµå›</div>
            </div>
            <div class="network-info" id="networkBadge">BSC</div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">
                    <span>è´¨æŠ¼ä¸­æ€»é¢</span>
                </div>
                <div class="stat-value">
                    <span id="stakedBalance">0.00</span>
                    <span class="stat-unit">USDT</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">
                    <span>å¯èµå›é‡‘é¢</span>
                </div>
                <div class="stat-value">
                    <span id="withdrawableBalance">0.00</span>
                    <span class="stat-unit">USDT</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">
                    <span>å¾…é¢†å–æ”¶ç›Š</span>
                </div>
                <div class="stat-value">
                    <span id="pendingRewards">0.00</span>
                    <span class="stat-unit">USDT</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">
                    <span>é’±åŒ…ä½™é¢</span>
                </div>
                <div class="stat-value">
                    <span id="walletBalance">0.00</span>
                    <span class="stat-unit">BNB</span>
                </div>
            </div>
        </div>

        <!-- èµå›æ“ä½œ -->
        <div class="action-card">
            <div class="card-title">
                <span>ğŸ’°</span>
                <span>èµå›è´¨æŠ¼</span>
            </div>
            
            <div class="input-group">
                <label class="input-label">èµå›é‡‘é¢ (USDT)</label>
                <div class="input-wrapper">
                    <input type="number" class="amount-input" id="withdrawAmount" placeholder="è¾“å…¥èµå›é‡‘é¢" min="0" step="0.01">
                    <div class="token-symbol">USDT</div>
                </div>
                
                <div class="percentage-buttons">
                    <button class="percentage-btn" data-percent="25" onclick="setAmount(25)">25%</button>
                    <button class="percentage-btn" data-percent="50" onclick="setAmount(50)">50%</button>
                    <button class="percentage-btn" data-percent="75" onclick="setAmount(75)">75%</button>
                    <button class="percentage-btn" data-percent="100" onclick="setAmount(100)">å…¨éƒ¨</button>
                </div>
                
                <div class="error-message" id="amountError"></div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn btn-primary" onclick="showWithdrawModal()" id="withdrawBtn" disabled>
                    <span>ç¡®è®¤èµå›</span>
                </button>
                <button class="action-btn btn-secondary" onclick="claimRewards()" id="claimBtn" disabled>
                    <span>é¢†å–æ”¶ç›Š</span>
                </button>
            </div>
        </div>

        <!-- è´¨æŠ¼è®°å½• -->
        <div class="records-card">
            <div class="records-header">
                <div class="card-title">
                    <span>ğŸ“‹</span>
                    <span>è´¨æŠ¼è®°å½•</span>
                </div>
                <button class="refresh-btn" onclick="loadStakingRecords()">
                    <span>ğŸ”„</span>
                    <span>åˆ·æ–°</span>
                </button>
            </div>
            
            <div class="records-list" id="recordsList">
                <div class="loading" id="loadingRecords">
                    <div class="spinner"></div>
                    <div>åŠ è½½è®°å½•ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¿æ¥é’±åŒ…æŒ‰é’® -->
    <div class="connect-section" id="connectSection">
        <button class="connect-btn" onclick="connectWallet()" id="connectBtn">
            <span>ğŸ”—</span>
            <span>è¿æ¥é’±åŒ…</span>
        </button>
    </div>

    <!-- ç¡®è®¤èµå›æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="withdrawModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ç¡®è®¤èµå›</div>
                <button class="modal-close" onclick="closeModal('withdrawModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: var(--spacing-lg);">
                    <div style="font-size: 48px; margin-bottom: var(--spacing-md);">âš ï¸</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: var(--spacing-md);">
                        è¯·ç¡®è®¤èµå›ä¿¡æ¯
                    </div>
                </div>
                
                <div class="transaction-info">
                    <div class="info-row">
                        <span class="info-label">èµå›é‡‘é¢</span>
                        <span class="info-value" id="modalAmount">0.00 USDT</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">é¢„è®¡Gasè´¹ç”¨</span>
                        <span class="info-value" id="modalGasFee">~0.001 BNB</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ç½‘ç»œæ‰‹ç»­è´¹</span>
                        <span class="info-value" style="color: var(--warning-color);">0.5%</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å®é™…åˆ°è´¦</span>
                        <span class="info-value" style="color: var(--primary-color);" id="modalActualAmount">0.00 USDT</span>
                    </div>
                </div>
                
                <div style="color: var(--text-secondary); font-size: 14px;">
                    <p style="margin-bottom: var(--spacing-xs);">âš ï¸ è´¨æŠ¼æœªæ»¡30å¤©æå‰èµå›å°†æ”¶å–0.5%æ‰‹ç»­è´¹</p>
                    <p style="margin-bottom: var(--spacing-xs);">â±ï¸ èµ„é‡‘å°†åœ¨1-3ä¸ªå·¥ä½œæ—¥å†…åˆ°è´¦</p>
                    <p>ğŸ”’ è¯·ç¡®ä¿è´¦æˆ·æœ‰è¶³å¤Ÿçš„BNBæ”¯ä»˜Gasè´¹ç”¨</p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('withdrawModal')">
                    å–æ¶ˆ
                </button>
                <button class="modal-btn modal-btn-primary" onclick="executeWithdraw()" id="confirmWithdrawBtn">
                    ç¡®è®¤èµå›
                </button>
            </div>
        </div>
    </div>

    <!-- äº¤æ˜“çŠ¶æ€æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">äº¤æ˜“å¤„ç†ä¸­</div>
            </div>
            
            <div class="modal-body">
                <div style="text-align: center; padding: var(--spacing-xl) 0;">
                    <div class="spinner"></div>
                    <div style="font-size: 16px; font-weight: 600; margin-top: var(--spacing-md);" id="transactionTitle">
                        å¤„ç†ä¸­...
                    </div>
                    <div style="color: var(--text-secondary); font-size: 14px; margin-top: var(--spacing-sm);" id="transactionMessage">
                        è¯·è€å¿ƒç­‰å¾…åŒºå—é“¾ç¡®è®¤
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆçº¦é…ç½®
        const CONTRACT_ADDRESS = '0x7E1882b471F627Ba75935BCb12105545Eb8b4227';
        
        // ç®€åŒ–çš„åˆçº¦ABIï¼ˆä»…åŒ…å«å…³é”®å‡½æ•°ï¼‰
        const STAKING_ABI = [
            {
                "inputs": [{"internalType": "uint256", "name": "index", "type": "uint256"}],
                "name": "unstake",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address", "name": "account", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"internalType": "uint256", "name": "balance", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address", "name": "user", "type": "address"}],
                "name": "getUserStakeRecords",
                "outputs": [{
                    "components": [
                        {"internalType": "uint40", "name": "stakeTime", "type": "uint40"},
                        {"internalType": "uint160", "name": "amount", "type": "uint160"},
                        {"internalType": "bool", "name": "status", "type": "bool"},
                        {"internalType": "uint8", "name": "stakeIndex", "type": "uint8"}
                    ],
                    "internalType": "struct Staking.Record[]",
                    "name": "records",
                    "type": "tuple[]"
                }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "sync",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalSupply",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // å…¨å±€å˜é‡
        let web3 = null;
        let stakingContract = null;
        let userAddress = null;
        let stakedBalance = 0;
        let pendingRewards = 0;
        let walletBalance = 0;
        let stakingRecords = [];
        let currentChainId = null;

        // æ£€æµ‹é’±åŒ…
        function detectWallet() {
            if (typeof window.tp !== 'undefined') {
                return 'tp';
            } else if (typeof window.ethereum !== 'undefined') {
                return 'metamask';
            } else if (typeof window.BinanceChain !== 'undefined') {
                return 'binance';
            } else {
                return null;
            }
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                const walletType = detectWallet();
                
                if (!walletType) {
                    showToast('è¯·å®‰è£…TPé’±åŒ…æˆ–MetaMaské’±åŒ…');
                    return;
                }
                
                let provider;
                if (walletType === 'tp') {
                    provider = window.tp;
                } else if (walletType === 'metamask') {
                    provider = window.ethereum;
                } else if (walletType === 'binance') {
                    provider = window.BinanceChain;
                }
                
                // è¯·æ±‚è´¦æˆ·è¿æ¥
                const accounts = await provider.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                
                if (!userAddress) {
                    throw new Error('æœªè·å–åˆ°è´¦æˆ·åœ°å€');
                }
                
                // åˆå§‹åŒ–Web3
                web3 = new Web3(provider);
                
                // åˆå§‹åŒ–åˆçº¦
                stakingContract = new web3.eth.Contract(STAKING_ABI, CONTRACT_ADDRESS);
                
                // æ›´æ–°UI
                updateConnectionUI();
                
                // åŠ è½½æ•°æ®
                await loadAllData();
                
                // éšè—è¿æ¥æŒ‰é’®
                document.getElementById('connectSection').style.display = 'none';
                
                // ç›‘å¬è´¦æˆ·å˜åŒ–
                provider.on('accountsChanged', handleAccountsChanged);
                provider.on('chainChanged', handleChainChanged);
                
                showToast('é’±åŒ…è¿æ¥æˆåŠŸï¼');
                
            } catch (error) {
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                showToast('è¿æ¥å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }

        // æ›´æ–°è¿æ¥UI
        function updateConnectionUI() {
            if (userAddress) {
                const shortAddress = userAddress.substring(0, 6) + '...' + userAddress.substring(38);
                document.getElementById('connectBtn').innerHTML = `<span>âœ…</span><span>${shortAddress}</span>`;
                document.getElementById('connectBtn').classList.add('connected');
            }
        }

        // å¤„ç†è´¦æˆ·å˜åŒ–
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                // ç”¨æˆ·æ–­å¼€è¿æ¥
                location.reload();
            } else if (accounts[0] !== userAddress) {
                // è´¦æˆ·åˆ‡æ¢
                userAddress = accounts[0];
                updateConnectionUI();
                loadAllData();
            }
        }

        // å¤„ç†ç½‘ç»œå˜åŒ–
        function handleChainChanged(chainId) {
            currentChainId = chainId;
            updateNetworkInfo();
            loadAllData();
        }

        // æ›´æ–°ç½‘ç»œä¿¡æ¯
        async function updateNetworkInfo() {
            try {
                if (!web3) return;
                
                const chainId = await web3.eth.getChainId();
                currentChainId = chainId;
                
                let networkName = 'Unknown';
                switch (chainId.toString()) {
                    case '56':
                        networkName = 'BSC';
                        break;
                    case '1':
                        networkName = 'ETH';
                        break;
                    case '137':
                        networkName = 'Polygon';
                        break;
                    case '42161':
                        networkName = 'Arbitrum';
                        break;
                    default:
                        networkName = `Chain ${chainId}`;
                }
                
                document.getElementById('networkBadge').textContent = networkName;
                
            } catch (error) {
                console.error('æ›´æ–°ç½‘ç»œä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            try {
                if (!stakingContract || !userAddress) return;
                
                await updateNetworkInfo();
                await loadBalanceData();
                await loadStakingRecords();
                
                // å¯ç”¨æ“ä½œæŒ‰é’®
                document.getElementById('withdrawBtn').disabled = false;
                document.getElementById('claimBtn').disabled = false;
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showToast('æ•°æ®åŠ è½½å¤±è´¥');
            }
        }

        // åŠ è½½ä½™é¢æ•°æ®
        async function loadBalanceData() {
            try {
                // è·å–è´¨æŠ¼ä½™é¢
                const balance = await stakingContract.methods.balanceOf(userAddress).call();
                stakedBalance = web3.utils.fromWei(balance, 'ether');
                document.getElementById('stakedBalance').textContent = parseFloat(stakedBalance).toFixed(2);
                document.getElementById('withdrawableBalance').textContent = parseFloat(stakedBalance).toFixed(2);
                
                // è®¡ç®—æ”¶ç›Šï¼ˆç¤ºä¾‹ï¼šè´¨æŠ¼æ€»é¢çš„0.3%ï¼‰
                pendingRewards = (parseFloat(stakedBalance) * 0.003).toFixed(4);
                document.getElementById('pendingRewards').textContent = pendingRewards;
                
                // è·å–é’±åŒ…ä½™é¢
                const walletBalanceWei = await web3.eth.getBalance(userAddress);
                walletBalance = web3.utils.fromWei(walletBalanceWei, 'ether');
                document.getElementById('walletBalance').textContent = parseFloat(walletBalance).toFixed(4);
                
            } catch (error) {
                console.error('åŠ è½½ä½™é¢å¤±è´¥:', error);
            }
        }

        // åŠ è½½è´¨æŠ¼è®°å½•
        async function loadStakingRecords() {
            const recordsList = document.getElementById('recordsList');
            
            try {
                recordsList.innerHTML = '<div class="loading"><div class="spinner"></div><div>åŠ è½½è®°å½•ä¸­...</div></div>';
                
                // è·å–è´¨æŠ¼è®°å½•
                const records = await stakingContract.methods.getUserStakeRecords(userAddress).call();
                stakingRecords = records;
                
                if (!records || records.length === 0) {
                    recordsList.innerHTML = '<div class="empty-state">æš‚æ— è´¨æŠ¼è®°å½•</div>';
                    return;
                }
                
                // æ¸²æŸ“è®°å½•
                recordsList.innerHTML = '';
                records.forEach((record, index) => {
                    const recordItem = createRecordElement(record, index);
                    recordsList.appendChild(recordItem);
                });
                
            } catch (error) {
                console.error('åŠ è½½è´¨æŠ¼è®°å½•å¤±è´¥:', error);
                recordsList.innerHTML = '<div class="empty-state" style="color: var(--error-color);">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }

        // åˆ›å»ºè®°å½•å…ƒç´ 
        function createRecordElement(record, index) {
            const recordItem = document.createElement('div');
            recordItem.className = 'record-item';
            
            const amount = web3.utils.fromWei(record.amount.toString(), 'ether');
            const stakeTime = new Date(record.stakeTime * 1000);
            const now = new Date();
            const daysStaked = Math.floor((now - stakeTime) / (1000 * 60 * 60 * 24));
            
            const timeString = stakeTime.toLocaleDateString('zh-CN') + ' ' + 
                              stakeTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
            
            const status = record.status ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­';
            const statusClass = record.status ? 'status-completed' : 'status-active';
            const canWithdraw = daysStaked >= 30;
            const withdrawButton = !record.status ? 
                `<button onclick="withdrawSingleRecord(${index})" style="margin-top: var(--spacing-sm); padding: var(--spacing-sm); background: ${canWithdraw ? 'rgba(76, 217, 100, 0.2)' : 'rgba(255, 59, 48, 0.2)'}; color: ${canWithdraw ? 'var(--primary-color)' : 'var(--error-color)'}; border: 1px solid ${canWithdraw ? 'var(--primary-color)' : 'var(--error-color)'}; border-radius: 8px; width: 100%; cursor: pointer; font-size: 14px;">${canWithdraw ? 'èµå›æ­¤ç¬”' : `éœ€ç­‰å¾…${30 - daysStaked}å¤©`}</button>` : '';
            
            recordItem.innerHTML = `
                <div class="record-header">
                    <div class="record-amount">${parseFloat(amount).toFixed(2)} USDT</div>
                    <div class="record-status ${statusClass}">${status}</div>
                </div>
                <div class="record-details">
                    <div>${timeString}</div>
                    <div style="color: ${canWithdraw ? 'var(--primary-color)' : 'var(--warning-color)'};">${daysStaked}å¤©</div>
                </div>
                ${withdrawButton}
            `;
            
            return recordItem;
        }

        // è®¾ç½®èµå›é‡‘é¢
        function setAmount(percentage) {
            const withdrawInput = document.getElementById('withdrawAmount');
            const amount = (stakedBalance * percentage / 100).toFixed(2);
            withdrawInput.value = amount > 0 ? amount : '';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.percentage-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.percent) === percentage) {
                    btn.classList.add('active');
                }
            });
            
            // æ¸…ç©ºé”™è¯¯ä¿¡æ¯
            document.getElementById('amountError').classList.remove('show');
        }

        // æ˜¾ç¤ºèµå›ç¡®è®¤æ¨¡æ€æ¡†
        function showWithdrawModal() {
            const amountInput = document.getElementById('withdrawAmount');
            const amount = parseFloat(amountInput.value);
            
            // éªŒè¯è¾“å…¥
            if (!amount || amount <= 0) {
                showError('amountError', 'è¯·è¾“å…¥æœ‰æ•ˆçš„èµå›é‡‘é¢');
                return;
            }
            
            if (amount > parseFloat(stakedBalance)) {
                showError('amountError', 'èµå›é‡‘é¢ä¸èƒ½è¶…è¿‡è´¨æŠ¼æ€»é¢');
                return;
            }
            
            // è®¡ç®—æ‰‹ç»­è´¹å’Œå®é™…åˆ°è´¦é‡‘é¢
            const fee = amount * 0.005; // 0.5%æ‰‹ç»­è´¹
            const actualAmount = amount - fee;
            
            // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
            document.getElementById('modalAmount').textContent = amount.toFixed(2) + ' USDT';
            document.getElementById('modalActualAmount').textContent = actualAmount.toFixed(2) + ' USDT';
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('withdrawModal').classList.add('active');
        }

        // èµå›å•ä¸ªè®°å½•
        function withdrawSingleRecord(index) {
            if (index >= stakingRecords.length) {
                showToast('è®°å½•ä¸å­˜åœ¨');
                return;
            }
            
            const record = stakingRecords[index];
            const amount = web3.utils.fromWei(record.amount.toString(), 'ether');
            const stakeTime = new Date(record.stakeTime * 1000);
            const now = new Date();
            const daysStaked = Math.floor((now - stakeTime) / (1000 * 60 * 60 * 24));
            
            if (daysStaked < 30) {
                showToast(`æ­¤ç¬”è´¨æŠ¼æœªæ»¡30å¤©ï¼Œè¿˜éœ€ç­‰å¾…${30 - daysStaked}å¤©æ‰èƒ½èµå›`);
                return;
            }
            
            // è®¾ç½®èµå›é‡‘é¢
            setAmount(100);
            document.getElementById('withdrawAmount').value = parseFloat(amount).toFixed(2);
            showWithdrawModal();
            
            // å­˜å‚¨å½“å‰ç´¢å¼•
            document.getElementById('withdrawModal').dataset.recordIndex = index;
        }

        // æ‰§è¡Œèµå›
        async function executeWithdraw() {
            const amountInput = document.getElementById('withdrawAmount');
            const amount = parseFloat(amountInput.value);
            
            if (!amount || amount <= 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„èµå›é‡‘é¢');
                return;
            }
            
            closeModal('withdrawModal');
            showTransactionModal('èµå›å¤„ç†ä¸­', 'è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤äº¤æ˜“');
            
            try {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨åˆçº¦çš„unstakeå‡½æ•°
                // æ³¨æ„ï¼šå®é™…è°ƒç”¨éœ€è¦æ ¹æ®å…·ä½“åˆçº¦é€»è¾‘
                
                // æ¨¡æ‹Ÿäº¤æ˜“è¿‡ç¨‹
                setTimeout(async () => {
                    showTransactionModal('äº¤æ˜“å·²æäº¤', 'ç­‰å¾…åŒºå—é“¾ç¡®è®¤...');
                    
                    setTimeout(() => {
                        showTransactionModal('äº¤æ˜“ç¡®è®¤ä¸­', 'è¯·ç¨å€™...');
                        
                        setTimeout(() => {
                            closeModal('transactionModal');
                            showToast('ğŸ‰ èµå›æˆåŠŸï¼');
                            
                            // æ¸…ç©ºè¾“å…¥
                            amountInput.value = '';
                            document.querySelectorAll('.percentage-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            
                            // åˆ·æ–°æ•°æ®
                            loadAllData();
                        }, 2000);
                    }, 1000);
                }, 1000);
                
            } catch (error) {
                closeModal('transactionModal');
                console.error('èµå›å¤±è´¥:', error);
                showToast('èµå›å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }

        // é¢†å–æ”¶ç›Š
        async function claimRewards() {
            if (!stakingContract || !userAddress) {
                showToast('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }
            
            showTransactionModal('æ”¶ç›Šé¢†å–ä¸­', 'è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤äº¤æ˜“');
            
            try {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨åˆçº¦çš„syncå‡½æ•°é¢†å–æ”¶ç›Š
                // å®é™…è°ƒç”¨éœ€è¦æ ¹æ®å…·ä½“åˆçº¦é€»è¾‘
                
                // æ¨¡æ‹Ÿäº¤æ˜“è¿‡ç¨‹
                setTimeout(async () => {
                    showTransactionModal('äº¤æ˜“å·²æäº¤', 'ç­‰å¾…åŒºå—é“¾ç¡®è®¤...');
                    
                    setTimeout(() => {
                        showTransactionModal('äº¤æ˜“ç¡®è®¤ä¸­', 'è¯·ç¨å€™...');
                        
                        setTimeout(() => {
                            closeModal('transactionModal');
                            showToast('ğŸ‰ æ”¶ç›Šé¢†å–æˆåŠŸï¼');
                            
                            // åˆ·æ–°æ•°æ®
                            loadAllData();
                        }, 2000);
                    }, 1000);
                }, 1000);
                
            } catch (error) {
                closeModal('transactionModal');
                console.error('é¢†å–æ”¶ç›Šå¤±è´¥:', error);
                showToast('é¢†å–å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }

        // æ˜¾ç¤ºäº¤æ˜“çŠ¶æ€æ¨¡æ€æ¡†
        function showTransactionModal(title, message) {
            document.getElementById('transactionTitle').textContent = title;
            document.getElementById('transactionMessage').textContent = message;
            document.getElementById('transactionModal').classList.add('active');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // æ˜¾ç¤ºToastæ¶ˆæ¯
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(elementId, message) {
            å¸¸é‡ errorElement = æ–‡æ¡£.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.add('show');
        }

        // è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬
        æ–‡æ¡£.getElementById('withdrawAmount').addEventListener('input', function() {
            // æ¸…ç©ºç™¾åˆ†æ¯”æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
            æ–‡æ¡£.querySelectorAll('.percentage-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ¸…ç©ºé”™è¯¯ä¿¡æ¯
            æ–‡æ¡£.getElementById('amountError').classList.remove('show');
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥é’±åŒ…è¿æ¥çŠ¶æ€
        window.addEventListener('load', async () => {
            try {
                const walletType = detectWallet();
                if (!walletType) {
                    return;
                }
                
                let provider;
                å¦‚æœ (walletType === 'tp') {
                    provider = window.tp;
                } else å¦‚æœ (walletType === 'metamask') {
                    provider = window.ethereum;
                }
                
                å¦‚æœ (provider) {
                    const accounts = await provider.request({ method: 'eth_accounts' });
                    å¦‚æœ (accounts.length > 0) {
                        ç”¨æˆ·åœ°å€ = accounts[0];
                        web3 = new Web3(provider);
                        stakingContract = new web3.eth.Contract(STAKING_ABI, CONTRACT_ADDRESS);
                        
                        updateConnectionUI();
                        await åŠ è½½æ‰€æœ‰æ•°æ®();
                        æ–‡æ¡£.getElementById('connectSection').style.display = 'none';
                    }
                }
            } catch (é”™è¯¯) {
                console.é”™è¯¯('è‡ªåŠ¨è¿æ¥å¤±è´¥:', é”™è¯¯);
            }
        });

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶åˆ·æ–°æ•°æ®
        æ–‡æ¡£.addEventListener('visibilitychange', å‡½æ•°() {
            å¦‚æœ (!æ–‡æ¡£.éšè— && ç”¨æˆ·åœ°å€) {
                åŠ è½½æ‰€æœ‰æ•°æ®();
            }
        });
    </script>
</body>
</html>
