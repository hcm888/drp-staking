<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>drp è´¨æŠ¼ç®¡ç†</title>
    <!-- å¼•å…¥ Bootstrap ç”¨äºå¿«é€Ÿå¸ƒå±€ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Ethers.js V6 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; }
        .card-title { color: #fff; }
        .btn-primary { background-color: #3b82f6; border: none; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-success { background-color: #10b981; border: none; }
        .btn-danger { background-color: #ef4444; border: none; }
        .btn-warning { background-color: #f59e0b; border: none; color: #fff; }
        .btn-warning:hover { background-color: #d97706; color: #fff; }
        .warning-box {
            background-color: #450a0a;
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        .stat-value { font-size: 1.25rem; font-weight: bold; color: #38bdf8; }
        .stat-label { font-size: 0.85rem; color: #94a3b8; }
        .table { color: #cbd5e1; }
        .table thead th { border-bottom: 1px solid #475569; color: #94a3b8; }
        .table td { border-bottom: 1px solid #334155; vertical-align: middle; }
        input.form-control { background-color: #334155; border-color: #475569; color: white; }
        input.form-control:focus { background-color: #334155; color: white; border-color: #38bdf8; box-shadow: none; }
        
        .align-items-end label.form-label {
            color: wheat;
        }
        
        /* è°ƒè¯•ä¿¡æ¯æ ·å¼ */
        .debug-panel {
            background-color: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.85rem;
        }
        .debug-title {
            color: #68d391;
            font-weight: bold;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .debug-content {
            display: none;
            color: #cbd5e1;
        }
        .debug-item {
            margin-bottom: 5px;
        }
        .debug-label {
            color: #a0aec0;
        }
        .debug-value {
            color: #68d391;
        }
        .debug-error {
            color: #fc8181;
        }
        .debug-warning {
            color: #f6e05e;
        }
    </style>
</head>
<body>

<div class="container py-5">
    <!-- è°ƒè¯•é¢æ¿ -->
    <div class="debug-panel">
        <div class="debug-title" onclick="toggleDebug()">ğŸ”§ é’±åŒ…è¿æ¥è°ƒè¯•ä¿¡æ¯ (ç‚¹å‡»å±•å¼€/æ”¶èµ·)</div>
        <div class="debug-content" id="debugContent">
            <div class="debug-item">
                <span class="debug-label">window.ethereum çŠ¶æ€:</span> 
                <span class="debug-value" id="debugEthereum">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="debug-item">
                <span class="debug-label">ç½‘ç»œçŠ¶æ€:</span> 
                <span class="debug-value" id="debugNetwork">æœªæ£€æµ‹</span>
            </div>
            <div class="debug-item">
                <span class="debug-label">å½“å‰è´¦æˆ·:</span> 
                <span class="debug-value" id="debugAccount">æœªè¿æ¥</span>
            </div>
            <div class="debug-item">
                <span class="debug-label">Provider çŠ¶æ€:</span> 
                <span class="debug-value" id="debugProvider">æœªåˆå§‹åŒ–</span>
            </div>
            <div class="debug-item">
                <span class="debug-label">é”™è¯¯ä¿¡æ¯:</span> 
                <span class="debug-error" id="debugError">æ— </span>
            </div>
            <div class="debug-item">
                <span class="debug-label">æ£€æŸ¥é¡¹:</span>
                <ul>
                    <li id="checkMetaMask">âœ… æ£€æŸ¥ MetaMask å®‰è£…çŠ¶æ€...</li>
                    <li id="checkNetwork">âœ… æ£€æŸ¥ BSC ç½‘ç»œ...</li>
                    <li id="checkChain">âœ… æ£€æŸ¥é“¾ID...</li>
                    <li id="checkAccounts">âœ… æ£€æŸ¥è´¦æˆ·æˆæƒ...</li>
                </ul>
            </div>
            <button class="btn btn-sm btn-outline-light mt-2" onclick="runDebug()">é‡æ–°æ£€æµ‹</button>
        </div>
    </div>

    <!-- ç‰¹åˆ«è¯´æ˜åŒºåŸŸ -->
    <div class="warning-box">
        <h5 class="text-danger fw-bold">âš ï¸ ç‰¹åˆ«è¯´æ˜</h5>
        <ol class="mb-0">
            <li>è¿™ä¸ªèµ„é‡‘ç›˜æ¯å¤©æ—¥åŒ–0.3%ï¼Œç¬¬ä¸€å¤©é”ä»“ï¼Œåé¢29å¤©ä¸é”ï¼Œè¶…è¿‡30å¤©æ²¡æœ‰æ”¶ç›Šã€‚</li>
            <li>è¦å´©ç›˜å‰2å¤©ä»¥ä¸Šï¼Œé¡µé¢ä¼šå…³é—­è´¨æŠ¼åŠŸèƒ½ï¼Œå¹¶æç¤ºè§£æŠ¼ã€‚</li>
            <li>æç¤ºå´©ç›˜å¯èƒ½ä¸€å‘¨ä»¥ä¸Šæ‰ä¼šå´©ç›˜ï¼Œä½†æ˜¯åˆ«èµšæœ€åä¸€åˆ†é’±ã€‚</li>
            <li>è¯·ç”¨ä¸€ä¸ªæ–°çš„å¹²å‡€é’±åŒ…æ¥å‚ä¸ã€‚</li>
        </ol>
    </div>

    <!-- é’±åŒ…è¿æ¥ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">drp Staking</h3>
        <button id="connectBtn" class="btn btn-primary" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
    </div>

    <!-- æ•°æ®ç»Ÿè®¡é¢æ¿ -->
    <div class="row mb-4 text-center g-2">
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">æˆ‘çš„ USDT ä½™é¢</div>
                <div class="stat-value" id="myBalance">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">å¾…æç°ä½™é¢ (åˆçº¦å†…)</div>
                <div class="stat-value" id="stakedBalance">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">å¯æç° USDT (æ± å­)</div>
                <div class="stat-value" id="poolBalance">0.0000</div>
            </div>
        </div>
    </div>

    <!-- è´¨æŠ¼æ“ä½œåŒºåŸŸ -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">å‚ä¸è´¨æŠ¼</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-8">
                    <label class="form-label">è´¨æŠ¼é‡‘é¢ (USDT)</label>
                    <input type="number" class="form-control" id="stakeAmount" value="1000" placeholder="è¾“å…¥é‡‘é¢">
                </div>
                <div class="col-md-4">
                    <label class="form-label d-block">æ“ä½œ</label>
                    <button class="btn btn-success w-100 mb-2" id="stakeBtn1" onclick="handleStake(0)">æˆæƒå¹¶è´¨æŠ¼ï¼ˆ1å¤©ï¼‰</button>
                    <button class="btn btn-success w-100" id="stakeBtn15" onclick="handleStake(1)">æˆæƒå¹¶è´¨æŠ¼ï¼ˆ15å¤©ï¼‰</button>
                </div>
            </div>
            <div class="mt-2 small text-white">
                * è´¨æŠ¼å‘¨æœŸä¸º1å¤©æˆ–15å¤©ã€‚
            </div>
        </div>
    </div>

    <!-- è´¨æŠ¼åˆ—è¡¨ -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">æˆ‘çš„è´¨æŠ¼è®°å½•</h5>
                <button class="btn btn-sm btn-outline-light" onclick="refreshData()">åˆ·æ–°æ•°æ®</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>é‡‘é¢ (USDT)</th>
                            <th>è´¨æŠ¼æ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="stakeListBody">
                        <tr><td colspan="5" class="text-center">è¯·è¿æ¥é’±åŒ…æŸ¥çœ‹æ•°æ®</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // ================= é…ç½®åŒºåŸŸ =================
    const CONFIG = {
        STAKING: "0x7E1882b471F627Ba75935BCb12105545Eb8b4227", // æ‚¨çš„åˆçº¦åœ°å€
        USDT: "0x55d398326f99059fF775485246999027B3197955",
        PAIR: "0xAB71C14094575C6ec8f2e61C708D5f4A3c3d5ca0",
        REFERRER: "0xdD59B2B78ac41BD670f0caEbb8b1249e61Cc471C",
        BSC_CHAIN_ID: "0x38", // BSCä¸»ç½‘é“¾ID: 56
        BSC_RPC_URL: "https://bsc-dataseed.binance.org/"
    };
    // ===========================================

    // ABIs
    const ABI_ERC20 = [
        "function balanceOf(address owner) view returns (uint256)",
        "function decimals() view returns (uint8)",
        "function approve(address spender, uint256 amount) returns (bool)",
        "function allowance(address owner, address spender) view returns (uint256)"
    ];

    const ABI_STAKING = [
        "function totalSupply() view returns (uint256)",
        "function balanceOf(address account) view returns (uint256)",
        "function stakeWithInviter(uint160 _amount, uint256 amountOutMin, uint8 _stakeIndex, address parent)",
        "function stake(uint160 _amount, uint256 amountOutMin, uint8 _stakeIndex)",
        "function unstake(uint256 index)",
        "function stakeCount(address user) view returns (uint256)",
        "function maxStakeAmount() view returns (uint256)",
        "function userStakeRecord(address user, uint256 index) view returns (uint40 stakeTime, uint160 amount, bool status, uint8 stakeIndex)"
    ];

    // å…¨å±€å˜é‡
    let provider, signer, userAddress;
    let stakingContract, usdtContract;

    // è°ƒè¯•å‡½æ•°
    function toggleDebug() {
        const content = document.getElementById('debugContent');
        content.style.display = content.style.display === 'block' ? 'none' : 'block';
    }

    function updateDebugInfo(key, value, isError = false) {
        const element = document.getElementById(key);
        if (element) {
            element.textContent = value;
            element.className = isError ? 'debug-error' : 'debug-value';
        }
    }

    function updateCheckStatus(id, status, message) {
        const element = document.getElementById(id);
        if (element) {
            element.innerHTML = `${status ? 'âœ…' : 'âŒ'} ${message}`;
            element.style.color = status ? '#68d391' : '#fc8181';
        }
    }

    async function runDebug() {
        console.log("å¼€å§‹è°ƒè¯•...");
        
        // æ£€æŸ¥ MetaMask
        if (window.ethereum) {
            updateDebugInfo('debugEthereum', 'å·²æ£€æµ‹åˆ°');
            updateCheckStatus('checkMetaMask', true, 'MetaMask å·²å®‰è£…');
            
            // æ£€æŸ¥ç½‘ç»œ
            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                updateDebugInfo('debugNetwork', `é“¾ID: ${chainId} (${parseInt(chainId)})`);
                updateCheckStatus('checkNetwork', chainId === CONFIG.BSC_CHAIN_ID, 
                    chainId === CONFIG.BSC_CHAIN_ID ? 'BSC ä¸»ç½‘' : 'è¯·åˆ‡æ¢åˆ° BSC ä¸»ç½‘');
                updateCheckStatus('checkChain', chainId === CONFIG.BSC_CHAIN_ID, 
                    `é“¾ID: ${chainId} ${chainId === CONFIG.BSC_CHAIN_ID ? 'æ­£ç¡®' : 'é”™è¯¯'}`);
                
                // æ£€æŸ¥è´¦æˆ·
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts && accounts.length > 0) {
                    updateDebugInfo('debugAccount', `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`);
                    updateCheckStatus('checkAccounts', true, 'è´¦æˆ·å·²æˆæƒ');
                } else {
                    updateDebugInfo('debugAccount', 'æœªè¿æ¥è´¦æˆ·');
                    updateCheckStatus('checkAccounts', false, 'è´¦æˆ·æœªæˆæƒï¼Œè¯·ç‚¹å‡»è¿æ¥é’±åŒ…');
                }
                
            } catch (error) {
                updateDebugInfo('debugError', error.message, true);
                updateCheckStatus('checkNetwork', false, 'ç½‘ç»œæ£€æŸ¥å¤±è´¥');
            }
        } else {
            updateDebugInfo('debugEthereum', 'æœªæ£€æµ‹åˆ° MetaMask', true);
            updateCheckStatus('checkMetaMask', false, 'è¯·å®‰è£… MetaMask é’±åŒ…æ‰©å±•');
            updateDebugInfo('debugError', 'è¯·å®‰è£… MetaMask é’±åŒ…æ‰©å±•', true);
        }
    }

    // å·¥å…·ï¼šæ ¼å¼åŒ–é‡‘é¢ä¸º4ä½å°æ•°
    function formatAmount(wei) {
        if (!wei) return "0.0000";
        const val = ethers.formatUnits(wei, 18);
        return parseFloat(val).toFixed(4);
    }

    // åˆ‡æ¢ç½‘ç»œåˆ°BSC
    async function switchToBSC() {
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: CONFIG.BSC_CHAIN_ID }],
            });
            return true;
        } catch (switchError) {
            // å¦‚æœç½‘ç»œæœªæ·»åŠ ï¼Œå°è¯•æ·»åŠ BSCç½‘ç»œ
            if (switchError.code === 4902) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: CONFIG.BSC_CHAIN_ID,
                            chainName: 'Binance Smart Chain Mainnet',
                            nativeCurrency: {
                                name: 'BNB',
                                symbol: 'BNB',
                                decimals: 18
                            },
                            rpcUrls: ['https://bsc-dataseed.binance.org/'],
                            blockExplorerUrls: ['https://bscscan.com/']
                        }]
                    });
                    return true;
                } catch (addError) {
                    console.error("æ·»åŠ BSCç½‘ç»œå¤±è´¥:", addError);
                    return false;
                }
            }
            return false;
        }
    }

    // æ£€æŸ¥å½“å‰ç½‘ç»œæ˜¯å¦ä¸ºBSC
    async function checkNetwork() {
        if (!window.ethereum) return false;
        
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        return chainId === CONFIG.BSC_CHAIN_ID;
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥é’±åŒ…è¿æ¥çŠ¶æ€
    window.addEventListener('load', async () => {
        // å¯åŠ¨è°ƒè¯•é¢æ¿
        await runDebug();
        
        // å¦‚æœä¹‹å‰å·²è¿æ¥ï¼Œè‡ªåŠ¨é‡è¿
        if (window.ethereum && window.ethereum.selectedAddress) {
            console.log("æ£€æµ‹åˆ°å·²è¿æ¥çš„é’±åŒ…ï¼Œå°è¯•è‡ªåŠ¨è¿æ¥...");
            try {
                await connectWallet();
            } catch (error) {
                console.log("è‡ªåŠ¨è¿æ¥å¤±è´¥ï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨è¿æ¥");
            }
        }
    });

    // ç›‘å¬ç½‘ç»œå˜åŒ–
    if (window.ethereum) {
        window.ethereum.on('chainChanged', async (chainId) => {
            console.log("ç½‘ç»œå·²åˆ‡æ¢:", chainId);
            updateDebugInfo('debugNetwork', `é“¾ID: ${chainId} (${parseInt(chainId)})`);
            if (chainId === CONFIG.BSC_CHAIN_ID) {
                updateCheckStatus('checkNetwork', true, 'BSC ä¸»ç½‘');
                // å¦‚æœæ˜¯BSCç½‘ç»œä¸”å·²è¿æ¥è´¦æˆ·ï¼Œåˆ·æ–°æ•°æ®
                if (userAddress) {
                    await refreshData();
                }
            } else {
                updateCheckStatus('checkNetwork', false, 'è¯·åˆ‡æ¢åˆ° BSC ä¸»ç½‘');
                alert("âš ï¸ è¯·åˆ‡æ¢åˆ° BSC ä¸»ç½‘");
            }
        });

        window.ethereum.on('accountsChanged', async (accounts) => {
            console.log("è´¦æˆ·å·²å˜æ›´:", accounts);
            if (accounts.length === 0) {
                // ç”¨æˆ·æ–­å¼€è¿æ¥
                updateDebugInfo('debugAccount', 'æœªè¿æ¥è´¦æˆ·');
                updateCheckStatus('checkAccounts', false, 'è´¦æˆ·å·²æ–­å¼€');
                document.getElementById('connectBtn').innerText = 'è¿æ¥é’±åŒ…';
                document.getElementById('connectBtn').classList.replace('btn-success', 'btn-primary');
                userAddress = null;
                // æ¸…ç©ºæ•°æ®æ˜¾ç¤º
                document.getElementById('myBalance').innerText = '0.0000';
                document.getElementById('stakedBalance').innerText = '0.0000';
                document.getElementById('poolBalance').innerText = '0.0000';
                document.getElementById('stakeListBody').innerHTML = '<tr><td colspan="5" class="text-center">è¯·è¿æ¥é’±åŒ…æŸ¥çœ‹æ•°æ®</td></tr>';
            } else {
                // ç”¨æˆ·åˆ‡æ¢è´¦æˆ·
                updateDebugInfo('debugAccount', `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`);
                updateCheckStatus('checkAccounts', true, 'è´¦æˆ·å·²è¿æ¥');
                // è‡ªåŠ¨é‡æ–°è¿æ¥
                await connectWallet();
            }
        });
    }

    // 1. è¿æ¥é’±åŒ…
    async function connectWallet() {
        if (!window.ethereum) {
            alert("è¯·å®‰è£… MetaMask é’±åŒ…æ‰©å±•ï¼");
            updateDebugInfo('debugError', 'MetaMask æœªå®‰è£…', true);
            return;
        }
        
        const connectBtn = document.getElementById('connectBtn');
        const originalText = connectBtn.innerText;
        
        try {
            connectBtn.disabled = true;
            connectBtn.innerText = "è¿æ¥ä¸­...";
            updateDebugInfo('debugError', 'è¿æ¥ä¸­...', false);
            
            // æ£€æŸ¥ç½‘ç»œ
            const isBSC = await checkNetwork();
            if (!isBSC) {
                const confirmSwitch = confirm("å½“å‰ç½‘ç»œä¸æ˜¯ BSC ä¸»ç½‘ï¼Œæ˜¯å¦åˆ‡æ¢åˆ° BSC ä¸»ç½‘ï¼Ÿ");
                if (confirmSwitch) {
                    const switched = await switchToBSC();
                    if (!switched) {
                        alert("åˆ‡æ¢ç½‘ç»œå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ‡æ¢åˆ° BSC ä¸»ç½‘");
                        updateDebugInfo('debugError', 'ç½‘ç»œåˆ‡æ¢å¤±è´¥', true);
                        return;
                    }
                } else {
                    alert("è¯·åˆ‡æ¢åˆ° BSC ä¸»ç½‘ä»¥ç»§ç»­");
                    updateDebugInfo('debugError', 'è¯·åœ¨MetaMaskä¸­åˆ‡æ¢åˆ°BSCä¸»ç½‘', true);
                    return;
                }
            }
            
            // è¯·æ±‚è´¦æˆ·è¿æ¥
            const accounts = await window.ethereum.request({ 
                method: 'eth_requestAccounts' 
            });
            
            if (!accounts || accounts.length === 0) {
                throw new Error("ç”¨æˆ·æ‹’ç»è¿æ¥");
            }
            
            userAddress = accounts[0];
            
            // åˆå§‹åŒ– provider å’Œ signer
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            
            // éªŒè¯è¿æ¥
            const network = await provider.getNetwork();
            const currentChainId = '0x' + network.chainId.toString(16);
            
            if (currentChainId !== CONFIG.BSC_CHAIN_ID) {
                alert("è¯·åœ¨ MetaMask ä¸­åˆ‡æ¢åˆ° BSC ä¸»ç½‘");
                updateDebugInfo('debugError', 'ç½‘ç»œä¸åŒ¹é…ï¼Œè¯·åˆ‡æ¢åˆ°BSCä¸»ç½‘', true);
                return;
            }
            
            // æ›´æ–°UI
            connectBtn.innerText = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
            connectBtn.classList.replace('btn-primary', 'btn-success');
            updateDebugInfo('debugAccount', `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`);
            updateCheckStatus('checkAccounts', true, 'è´¦æˆ·å·²è¿æ¥');
            
            // åˆå§‹åŒ–åˆçº¦
            stakingContract = new ethers.Contract(CONFIG.STAKING, ABI_STAKING, signer);
            usdtContract = new ethers.Contract(CONFIG.USDT, ABI_ERC20, signer);
            updateDebugInfo('debugProvider', 'å·²åˆå§‹åŒ–');
            
            // åŠ è½½æ•°æ®
            await refreshData();
            updateDebugInfo('debugError', 'è¿æ¥æˆåŠŸ', false);
            
        } catch (error) {
            console.error("è¿æ¥å¤±è´¥:", error);
            
            let errorMsg = "è¿æ¥é’±åŒ…å¤±è´¥";
            if (error.code === 4001) {
                errorammMsg = "ç”¨æˆ·æ‹’ç»è¿æ¥";
            } else if (error.code === -32002) {
                errorMsg = "è¿æ¥è¯·æ±‚å·²å­˜åœ¨ï¼Œè¯·åœ¨MetaMaskä¸­å¤„ç†";
            } else if (error.message.includes("user rejected")) {
                errorMsg = "ç”¨æˆ·æ‹’ç»è¿æ¥è¯·æ±‚";
            }
            
            alert(errorMsg);
            updateDebugInfo('debugError', error.message || errorMsg, true);
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            connectBtn.innerText = originalText;
            connectBtn.classList.replace('btn-success', 'btn-primary');
        } finally {
            connectBtn.disabled = false;
            connectBtn.innerText = userAddress 
                ? userAddress.slice(0, 6) + "..." + userAddress.slice(-4) 
                : "è¿æ¥é’±åŒ…";
        }
    }

    // 2. åˆ·æ–°æ‰€æœ‰æ•°æ®
    async function refreshData() {
        if (!userAddress) return;
        
        const btn = document.querySelector('button[onclick="refreshData()"]');
        const originalText = btn ? btn.innerText : "åˆ·æ–°";
        
        if (btn) btn.innerText = "åŠ è½½ä¸­...";
        
        try {
            // 2.1 è·å–æˆ‘çš„ USDT ä½™é¢
            const myBal = await usdtContract.balanceOf(userAddress);
            document.getElementById('myBalance').innerText = formatAmount(myBal);

            // 2.2 è·å–å¾…æç°ä½™é¢ (åˆçº¦å†…çš„ balanceOf)
            const stakedBal = await stakingContract.balanceOf(userAddress);
            document.getElementById('stakedBalance').innerText = formatAmount(stakedBal);

            // 2.3 è·å–å¯æç°ä½™é¢ (æ± å­é‡Œçš„ USDT)
            const poolBal = await usdtContract.balanceOf(CONFIG.PAIR);
            document.getElementById('poolBalance').innerText = formatAmount(poolBal);

            // 2.5 è·å–è´¨æŠ¼åˆ—è¡¨
            await renderStakeList();
            
            if (btn) btn.innerText = originalText;
        } catch (error) {
            console.error("æ•°æ®åŠ è½½é”™è¯¯:", error);
            if (btn) btn.innerText = "åˆ·æ–°å¤±è´¥";
            setTimeout(() => {
                if (btn) btn.innerText = originalText;
            }, 2000);
        }
    }

    // 3. æ¸²æŸ“è´¨æŠ¼åˆ—è¡¨
    async function renderStakeList() {
        const tbody = document.getElementById('stakeListBody');
        if (!tbody) return;
        
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">åŠ è½½ä¸­...</td></tr>';

        try {
            const count = await stakingContract.stakeCount(userAddress);
            let html = '';
            
            const now = Math.floor(Date.now() / 1000);

            // å€’åºæ˜¾ç¤º
            for (let i = Number(count) - 1; i >= 0; i--) {
                const record = await stakingContract.userStakeRecord(userAddress, i);
                
                const amount = formatAmount(record[1]); 
                const stakeTime = Number(record[0]);
                const stakeTimeStr = new Date(stakeTime * 1000).toLocaleString();
                const isActive = record[2]; 
                
                // è®¡ç®—é”å®šçŠ¶æ€
                const stakeDays = record[3] === 0 ? 1 : 15;
                const unlockTime = stakeTime + (stakeDays * 86400);
                const isLocked = now < unlockTime;

                let statusHtml = '';
                let actionHtml = '';

                if (isActive) {
                    statusHtml = '<span class="text-muted">å·²æå–</span>';
                    actionHtml = '-';
                } else {
                    if (isLocked) {
                        // é”ä»“ä¸­
                        const leftSeconds = unlockTime - now;
                        const h = Math.floor(leftSeconds / 3600);
                        const m = Math.floor((leftSeconds % 3600) / 60);
                        statusHtml = `<span class="text-warning">é”ä»“ä¸­ (${stakeDays}å¤©)</span>`;
                        actionHtml = `<button class="btn btn-sm btn-secondary" disabled>å‰©ä½™ ${h}h ${m}m</button>`;
                    } else {
                        // å¯èµå›
                        statusHtml = `<span class="text-success">å¯èµå›</span>`;
                        actionHtml = `<button class="btn btn-sm btn-warning" id="unstake-btn-${i}" onclick="handleUnstake(${i})">èµå›</button>`;
                    }
                }

                html += `
                    <tr>
                        <td>${i}</td>
                        <td>${amount}</td>
                        <td>${stakeTimeStr}</td>
                        <td>${statusHtml}</td>
                        <td>${actionHtml}</td>
                    </tr>
                `;
            }

            if (Number(count) === 0) {
                html = '<tr><td colspan="5" class="text-center">æš‚æ— è´¨æŠ¼è®°å½•</td></tr>';
            }

            tbody.innerHTML = html;
        } catch (error) {
            console.error("åˆ—è¡¨åŠ è½½å¤±è´¥:", error);
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">åˆ—è¡¨åŠ è½½å¤±è´¥</td></tr>';
        }
    }

    // 4. è´¨æŠ¼é€»è¾‘
    async function handleStake(stakeIndex) {
        if (!userAddress) {
            alert("è¯·å…ˆè¿æ¥é’±åŒ…");
            return;
        }
        
        const amountStr = document.getElementById('stakeAmount').value;
        if (!amountStr || parseFloat(amountStr) <= 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");
            return;
        }
        
        const amountWei = ethers.parseUnits(amountStr, 18);
        const referrer = CONFIG.REFERRER;
        const btn = document.getElementById(stakeIndex === 0 ? 'stakeBtn1' : 'stakeBtn15');

        try {
            btn.disabled = true;
            btn.innerText = "å¤„ç†ä¸­...";

            // 0. é™æµæ£€æŸ¥
            const maxStakeAmount = await stakingContract.maxStakeAmount();
            const maxAmount = ethers.parseUnits("1000", 18);
            if (maxStakeAmount < amountWei) {
                alert("è¶…è¿‡æœ€å¤§è´¨æŠ¼é™é¢");
                return;
            }

            // 1. æ£€æŸ¥å¹¶æˆæƒ USDT
            const allowance = await usdtContract.allowance(userAddress, CONFIG.STAKING);
            if (allowance < amountWei) {
                btn.innerText = "æ­£åœ¨æˆæƒ USDT...";
                const txApprove = await usdtContract.approve(CONFIG.STAKING, ethers.MaxUint256); 
                await txApprove.wait();
            }

            // 2. å‘èµ·è´¨æŠ¼
            btn.innerText = "æ­£åœ¨è´¨æŠ¼...";
            const txStake = await stakingContract.stake(
                amountWei, 
                0, 
                stakeIndex
            );
            
            await txStake.wait();
            alert("è´¨æŠ¼æˆåŠŸï¼");
            await refreshData();

        } catch (error) {
            æ§åˆ¶å°.é”™è¯¯(é”™è¯¯);
            if(error.reason) alert("åˆçº¦é”™è¯¯: " + error.reason);
            else if(error.message.includes("User denied")) alert("ç”¨æˆ·å–æ¶ˆäº¤æ˜“");
            else if(error.message.includes("insufficient funds")) alert("ä½™é¢ä¸è¶³");
            else if(error.message.includes("exceeds max stake amount")) alert("è¶…è¿‡æœ€å¤§è´¨æŠ¼é™é¢");
            else alert("è´¨æŠ¼å¤±è´¥: " + error.message);
        } finally {
            æŒ‰é’®.ç¦ç”¨ = å‡;
            btn.innerText = stakeIndex === 0 ? "æˆæƒå¹¶è´¨æŠ¼ï¼ˆ1å¤©ï¼‰" : "æˆæƒå¹¶è´¨æŠ¼ï¼ˆ15å¤©ï¼‰";
        }
    }

    // 5. èµå›é€»è¾‘
    async function handleUnstake(index) {
        if (!userAddress) {
            alert("è¯·å…ˆè¿æ¥é’±åŒ…");
            return;
        }
        
        const btn = document.getElementById(`unstake-btn-${index}`);
        if(!btn) {
            alert("æ“ä½œå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
            return;
        }
        
        btn.disabled = true;
        btn.innerText = "å¤„ç†ä¸­...";

        å°è¯• {
            const tx = await stakingContract.unstake(index);
            console.log("äº¤æ˜“å·²å‘é€:", tx.å“ˆå¸Œ);
            
            await tx.wait();
            è­¦å‘Š(â€œèµå›æˆåŠŸï¼â€);
            await refreshData();

        } catch (error) {
            æ§åˆ¶å°.é”™è¯¯(é”™è¯¯);
            å¦‚æœ(æŒ‰é’®) {
                æŒ‰é’®.ç¦ç”¨ = å‡;
                æŒ‰é’®.innerText = â€œèµå›â€;
            }
            
            if(error.reason) alert("åˆçº¦é”™è¯¯: " + error.reason);
            else if(error.message.includes("User denied")) alert("ç”¨æˆ·å–æ¶ˆäº¤æ˜“");
            å¦åˆ™å¦‚æœ(é”™è¯¯.æ¶ˆæ¯åŒ…å«"ä»è¢«é”å®š")æç¤º"è´¨æŠ¼ä»åœ¨é”å®šæœŸï¼Œæ— æ³•èµå›";
            else alert("èµå›å¤±è´¥: " + error.message);
        }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–è°ƒè¯•ä¿¡æ¯
    document.addEventListener('DOMContentLoaded', function() {
        è¿è¡Œè°ƒè¯•();
    });
</script>
</body>
</html>
